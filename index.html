<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced FX & Interest Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .step-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .step-row:last-child {
            border-bottom: none;
        }
        .step-label {
            color: #4b5563;
        }
        .step-value {
            font-weight: 600;
            color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Advanced FX & Interest Calculator</h1>
                <p class="text-gray-600 mb-6">Analyze your EUR to TRY conversion with breakeven points and historical data.</p>
                
                <!-- Tabs -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                        <button class="tab-button active" data-tab="calculator">Calculator</button>
                        <button class="tab-button" data-tab="analysis">Breakeven Analysis</button>
                        <button class="tab-button" data-tab="chart">Historical Chart</button>
                    </nav>
                </div>

                <!-- Calculator Tab -->
                <div id="calculator" class="tab-content active mt-6">
                    <!-- Input Section -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">1. Enter Your Scenario</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="eurAmount" class="block text-sm font-medium text-gray-700">Amount to Send (EUR)</label>
                                <input type="number" id="eurAmount" placeholder="e.g., 1000" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="manualRate" class="block text-sm font-medium text-gray-700">Manual EUR/TRY Rate</label>
                                <input type="number" id="manualRate" placeholder="Leave blank for live rate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div class="md:col-span-2">
                                <label for="expenseValue" class="block text-sm font-medium text-gray-700">Sending Expense</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="number" id="expenseValue" value="1.1" class="block w-full flex-1 rounded-none rounded-l-md px-3 py-2 border border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <select id="expenseType" class="inline-flex items-center rounded-r-md border border-l-0 border-gray-300 bg-gray-50 px-3 text-sm text-gray-500">
                                        <option value="percent">%</option>
                                        <option value="amount">EUR</option>
                                    </select>
                                </div>
                            </div>
                             <div>
                                <label for="monthlyInterestRate" class="block text-sm font-medium text-gray-700">
                                    <a href="https://www.garantibbvaportfoy.com.tr/birinci-para-piyasasi-fonu" target="_blank" class="text-indigo-600 hover:underline">Monthly Interest Rate (%)</a>
                                </label>
                                <input type="number" id="monthlyInterestRate" value="3.5" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                             </div>
                             <div>
                                <label for="investmentDays" class="block text-sm font-medium text-gray-700">Number of Days to Invest</label>
                                <input type="number" id="investmentDays" value="30" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                             </div>
                        </div>
                    </div>
                     <!-- Results Section -->
                    <div id="results-wrapper" class="mt-6 hidden">
                        <div class="bg-gray-50 p-6 rounded-lg mb-6">
                             <h2 class="text-xl font-semibold text-gray-800 mb-4">Conversion & Interest Results</h2>
                             <div id="conversionResult"></div>
                             <div id="interestResult" class="mt-4"></div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Tab -->
                <div id="analysis" class="tab-content mt-6">
                    <div id="breakeven-wrapper" class="hidden">
                        <div class="bg-blue-50 p-6 rounded-lg mb-6">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Breakeven FX Rate Analysis</h2>
                            <div id="breakevenResult"></div>
                        </div>
                        <div class="bg-green-50 p-6 rounded-lg">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Reverse Breakeven Analysis</h2>
                             <div class="mb-4">
                                <label for="targetRate" class="block text-sm font-medium text-gray-700">If future EUR/TRY rate is...</label>
                                <input type="number" id="targetRate" placeholder="e.g., 35.5" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div id="reverseBreakevenResult"></div>
                        </div>
                    </div>
                     <p id="analysis-placeholder" class="text-center text-gray-500 mt-12">Calculate a scenario on the 'Calculator' tab to see the analysis.</p>
                </div>

                <!-- Chart Tab -->
                <div id="chart" class="tab-content mt-6">
                    <p class="text-sm text-center text-gray-500 mb-4">EUR/TRY Exchange Rate - Last 30 Days</p>
                    <canvas id="rateChart"></canvas>
                </div>
                
                <button id="calculateBtn" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out mb-6">
                    Calculate
                </button>

                 <div id="loading" class="mt-6 text-center hidden">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                    <p class="text-gray-600 mt-2">Fetching live rate...</p>
                </div>
                 <div id="apiError" class="mt-4 p-4 bg-red-50 rounded-lg hidden">
                    <p class="text-sm font-medium text-red-800">Error</p>
                    <p class="text-sm text-red-700 mt-1">Could not perform calculation. Please check all input values and try again.</p>
                </div>

                <div class="mt-8 text-xs text-gray-500 text-center">
                    <p><strong>Disclaimer:</strong> This is a tool for estimation purposes only. Exchange rates and interest rates fluctuate. The sending expense is an estimate. Consult with your financial institution for exact figures.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const calculateBtn = document.getElementById('calculateBtn');
        const eurAmountInput = document.getElementById('eurAmount');
        const manualRateInput = document.getElementById('manualRate');
        const expenseValueInput = document.getElementById('expenseValue');
        const expenseTypeSelect = document.getElementById('expenseType');
        const monthlyInterestRateInput = document.getElementById('monthlyInterestRate');
        const investmentDaysInput = document.getElementById('investmentDays');
        const targetRateInput = document.getElementById('targetRate');

        const conversionResultDiv = document.getElementById('conversionResult');
        const interestResultDiv = document.getElementById('interestResult');
        const breakevenResultDiv = document.getElementById('breakevenResult');
        const reverseBreakevenResultDiv = document.getElementById('reverseBreakevenResult');

        const loadingDiv = document.getElementById('loading');
        const apiErrorDiv = document.getElementById('apiError');
        const resultsWrapper = document.getElementById('results-wrapper');
        const breakevenWrapper = document.getElementById('breakeven-wrapper');
        const analysisPlaceholder = document.getElementById('analysis-placeholder');
        
        const INTEREST_TAX_RATE = 0.15;
        let rateChart;
        let lastUsedRate = 0;

        // --- Tab Logic ---
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
                const target = document.getElementById(tab.dataset.tab);
                tabContents.forEach(content => content.classList.remove('active'));
                target.classList.add('active');
            });
        });
        
        // --- Main Calculation Logic ---
        function createRow(label, value, valueClass = '') {
            return `
                <div class="step-row">
                    <span class="step-label">${label}</span>
                    <span class="step-value ${valueClass}">${value}</span>
                </div>`;
        }
        
        function runCalculations(eurToTryRate) {
            lastUsedRate = eurToTryRate;
            const eurAmount = parseFloat(eurAmountInput.value);
            const monthlyInterestRate = parseFloat(monthlyInterestRateInput.value);
            const investmentDays = parseInt(investmentDaysInput.value);
            const expenseValue = parseFloat(expenseValueInput.value);
            const expenseType = expenseTypeSelect.value;
            const targetRate = parseFloat(targetRateInput.value);
            
            let expenseAmount, netTryAmount, breakevenRate;

            // 1. Conversion
            const grossTryAmount = eurAmount * eurToTryRate;
            if (expenseType === 'percent') {
                const sendingExpenseRate = expenseValue / 100;
                expenseAmount = grossTryAmount * sendingExpenseRate;
            } else {
                expenseAmount = expenseValue * eurToTryRate;
            }
            netTryAmount = grossTryAmount - expenseAmount;
            
            conversionResultDiv.innerHTML = 
                createRow('Used EUR/TRY Rate', `${eurToTryRate.toFixed(4)}`) +
                createRow('Gross Amount', `${grossTryAmount.toFixed(2)} TRY`) +
                createRow(`Sending Expense`, `<span class="text-red-600">- ${expenseAmount.toFixed(2)} TRY</span>`) +
                createRow('<strong>Net Received Amount</strong>', `<strong class="text-xl text-indigo-600">${netTryAmount.toFixed(2)} TRY</strong>`);

            // 2. Interest
            const dailyInterestRate = monthlyInterestRate / 30;
            const grossInterestForPeriod = netTryAmount * (dailyInterestRate / 100) * investmentDays;
            const taxOnInterest = grossInterestForPeriod * INTEREST_TAX_RATE;
            const netInterestForPeriod = grossInterestForPeriod - taxOnInterest;

            interestResultDiv.innerHTML = 
                createRow(`Gross Interest for ${investmentDays} Days`, `${grossInterestForPeriod.toFixed(2)} TRY`) +
                createRow('Withholding Tax (15%)', `<span class="text-red-600">- ${taxOnInterest.toFixed(2)} TRY</span>`) +
                createRow(`<strong>Net Interest for ${investmentDays} Days</strong>`, `<strong class="text-xl text-green-600">${netInterestForPeriod.toFixed(2)} TRY</strong>`);

            // 3. Breakeven
            const totalFutureValue = netTryAmount + netInterestForPeriod;
            if (expenseType === 'percent') {
                const sendingExpenseRate = expenseValue / 100;
                const futureGrossTryEquivalent = totalFutureValue / (1 - sendingExpenseRate);
                breakevenRate = futureGrossTryEquivalent / eurAmount;
            } else {
                breakevenRate = totalFutureValue / (eurAmount - expenseValue);
            }
            const rateDifference = breakevenRate - eurToTryRate;

            breakevenResultDiv.innerHTML = 
                createRow('Total Value (Principal + Net Interest)', `${totalFutureValue.toFixed(2)} TRY`) +
                createRow('<strong>Breakeven EUR/TRY Rate</strong>', `<strong class="text-xl text-blue-600">${breakevenRate.toFixed(4)}</strong>`) +
                createRow('Required Rate Increase', `<span class="text-blue-600 font-semibold">${rateDifference.toFixed(4)} <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg></span>`);

            // 4. Reverse Breakeven
            if (!isNaN(targetRate) && targetRate > 0) {
                 const targetGrossTry = eurAmount * targetRate;
                 let targetNetTry;
                 if (expenseType === 'percent') {
                    targetNetTry = targetGrossTry * (1 - (expenseValue / 100));
                 } else {
                    targetNetTry = targetGrossTry - (expenseValue * targetRate);
                 }
                 const requiredInterest = targetNetTry - netTryAmount;
                 if (requiredInterest > 0 && dailyInterestRate > 0) {
                    const requiredDays = requiredInterest / (netTryAmount * (dailyInterestRate / 100) * (1-INTEREST_TAX_RATE));
                    reverseBreakevenResultDiv.innerHTML = createRow(`To match a rate of ${targetRate.toFixed(4)}, you would need to earn interest for ~<strong>${Math.ceil(requiredDays)} days</strong>.`, '');
                 } else {
                    reverseBreakevenResultDiv.innerHTML = createRow(`The target rate of ${targetRate.toFixed(4)} is already lower than the net conversion rate.`, '');
                 }
            } else {
                reverseBreakevenResultDiv.innerHTML = `<p class="text-sm text-gray-500">Enter a target rate to see the required investment period.</p>`;
            }


            // Show results
            resultsWrapper.classList.remove('hidden');
            breakevenWrapper.classList.remove('hidden');
            analysisPlaceholder.classList.add('hidden');
            calculateBtn.textContent = "Recalculate";
        }

        async function performCalculations() {
            const inputs = [eurAmountInput, monthlyInterestRateInput, investmentDaysInput, expenseValueInput];
            if (inputs.some(input => isNaN(parseFloat(input.value)) || parseFloat(input.value) < 0)) {
                apiErrorDiv.classList.remove('hidden');
                return;
            }
            
            apiErrorDiv.classList.add('hidden');
            resultsWrapper.classList.add('hidden');
            breakevenWrapper.classList.add('hidden');
            analysisPlaceholder.classList.remove('hidden');

            try {
                const manualRate = parseFloat(manualRateInput.value);
                if (!isNaN(manualRate) && manualRate > 0) {
                    runCalculations(manualRate);
                } else {
                    loadingDiv.classList.remove('hidden');
                    const response = await fetch('https://api.frankfurter.app/latest?from=EUR&to=TRY');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    if (!data || !data.rates || !data.rates.TRY) throw new Error('Invalid API response.');
                    runCalculations(data.rates.TRY);
                }
            } catch (error) {
                console.error("Calculation Error:", error);
                apiErrorDiv.classList.remove('hidden');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }
        
        // --- Chart Logic ---
        async function fetchAndDrawChart() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 30);
            const formattedStartDate = startDate.toISOString().split('T')[0];
            
            try {
                const response = await fetch(`https://api.frankfurter.app/${formattedStartDate}..`);
                const data = await response.json();
                const rates = data.rates;
                const labels = Object.keys(rates).sort();
                const chartData = labels.map(date => rates[date].TRY);

                const ctx = document.getElementById('rateChart').getContext('2d');
                if(rateChart) {
                    rateChart.destroy();
                }
                rateChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'EUR to TRY Exchange Rate',
                            data: chartData,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Chart Error:", error);
                document.getElementById('chart').innerHTML = `<p class="text-center text-red-500">Could not load historical data.</p>`;
            }
        }
        
        // --- Event Listeners ---
        calculateBtn.addEventListener('click', performCalculations);
        targetRateInput.addEventListener('input', () => {
             if(lastUsedRate > 0) runCalculations(lastUsedRate);
        });

        // Initial Load
        fetchAndDrawChart();

    </script>

</body>
</html>
